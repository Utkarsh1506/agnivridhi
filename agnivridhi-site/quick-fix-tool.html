<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Fix Tool - Agnivridhi Forms</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"/>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .fix-container {
            max-width: 900px;
            margin: 0 auto;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        .card-header {
            background: linear-gradient(135deg, #0891b2 0%, #155e75 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 20px;
        }
        .step {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #0891b2;
        }
        .step.completed {
            border-left-color: #28a745;
            background: #f0fff4;
        }
        .step.failed {
            border-left-color: #dc3545;
            background: #fff5f5;
        }
        .btn-fix {
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            border: none;
            color: white;
            padding: 15px 30px;
            font-weight: bold;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(245, 158, 11, 0.3);
        }
        .btn-fix:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4);
        }
        .status-badge {
            display: inline-block;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-pending { background: #fef3c7; color: #f59e0b; }
        .status-success { background: #d1fae5; color: #059669; }
        .status-error { background: #fee2e2; color: #dc2626; }
        pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 13px;
        }
        .info-box {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="fix-container">
        <div class="text-center text-white mb-4">
            <h1 class="mb-2"><i class="fas fa-tools"></i> Form Fix Tool</h1>
            <p>Diagnose and fix form submission issues in 3 minutes</p>
        </div>

        <!-- Current Status -->
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0"><i class="fas fa-clipboard-check"></i> Current Configuration</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Google Sheets URL:</strong></p>
                        <pre id="currentUrl" style="font-size: 10px;"></pre>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Status:</strong></p>
                        <span id="configStatus" class="status-badge status-pending">Checking...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Diagnostic Steps -->
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0"><i class="fas fa-stethoscope"></i> Diagnostic Steps</h4>
            </div>
            <div class="card-body">
                <div id="step1" class="step">
                    <h5><i class="fas fa-circle-notch fa-spin"></i> Step 1: Testing Google Sheets Connection</h5>
                    <p class="text-muted mb-0">Verifying if the Apps Script endpoint is accessible...</p>
                    <div id="step1Result"></div>
                </div>

                <div id="step2" class="step">
                    <h5><i class="fas fa-hourglass-half"></i> Step 2: Testing Data Submission</h5>
                    <p class="text-muted mb-0">Sending test data to Google Sheets...</p>
                    <div id="step2Result"></div>
                </div>

                <div id="step3" class="step">
                    <h5><i class="fas fa-hourglass-half"></i> Step 3: Verifying Form Handlers</h5>
                    <p class="text-muted mb-0">Checking if form submission code is properly configured...</p>
                    <div id="step3Result"></div>
                </div>

                <div id="step4" class="step">
                    <h5><i class="fas fa-hourglass-half"></i> Step 4: Email Notification Check</h5>
                    <p class="text-muted mb-0">Verifying email configuration...</p>
                    <div id="step4Result"></div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="card">
            <div class="card-body text-center">
                <button id="runDiagnostic" class="btn btn-fix btn-lg me-3">
                    <i class="fas fa-play-circle"></i> Run Full Diagnostic
                </button>
                <button id="testForms" class="btn btn-primary btn-lg">
                    <i class="fas fa-vial"></i> Test Forms
                </button>
            </div>
        </div>

        <!-- Solutions -->
        <div id="solutionsCard" class="card" style="display: none;">
            <div class="card-header bg-warning text-dark">
                <h4 class="mb-0"><i class="fas fa-wrench"></i> Recommended Solutions</h4>
            </div>
            <div class="card-body">
                <div id="solutions"></div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="card">
            <div class="card-header bg-info text-white">
                <h4 class="mb-0"><i class="fas fa-info-circle"></i> What This Tool Does</h4>
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    <li>✅ Tests connection to Google Sheets Apps Script</li>
                    <li>✅ Verifies data submission workflow</li>
                    <li>✅ Checks form field mappings</li>
                    <li>✅ Provides specific fix instructions</li>
                </ul>
                
                <div class="info-box mt-3">
                    <strong><i class="fas fa-lightbulb"></i> Note:</strong> 
                    This tool uses the <code>no-cors</code> mode, so some responses may not be visible. 
                    Check your Google Sheet directly for test entries.
                </div>
            </div>
        </div>
    </div>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script>
        const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbxhXssWcCEYQarFtOakmxU4iizigxPbPUiPf-_-Bb368ZFpB45GEw0lrKpXYgdk9Ix3/exec';
        
        // Display current config
        $('#currentUrl').text(GOOGLE_SHEETS_URL);        let issuesFound = [];

        // Step 1: Test Connection
        async function testConnection() {
            $('#step1').removeClass('completed failed');
            $('#step1 i').attr('class', 'fas fa-circle-notch fa-spin');
            
            try {
                const response = await fetch(GOOGLE_SHEETS_URL, {
                    method: 'GET',
                    mode: 'no-cors'
                });
                
                $('#step1').addClass('completed');
                $('#step1 i').attr('class', 'fas fa-check-circle text-success');
                $('#step1Result').html(`
                    <div class="alert alert-success mt-3 mb-0">
                        <strong>✅ Connection Successful</strong><br>
                        The Google Sheets URL is accessible. Request was sent successfully.
                    </div>
                `);
                $('#configStatus').removeClass('status-pending').addClass('status-success').text('Connected');
                return true;
            } catch (error) {
                $('#step1').addClass('failed');
                $('#step1 i').attr('class', 'fas fa-times-circle text-danger');
                $('#step1Result').html(`
                    <div class="alert alert-danger mt-3 mb-0">
                        <strong>❌ Connection Failed</strong><br>
                        Error: ${error.message}
                    </div>
                `);
                $('#configStatus').removeClass('status-pending').addClass('status-error').text('Connection Failed');
                issuesFound.push({
                    title: 'Google Sheets Connection Failed',
                    solution: `
                        <h5>Solution:</h5>
                        <ol>
                            <li>Open your Google Sheet</li>
                            <li>Go to Extensions → Apps Script</li>
                            <li>Click Deploy → Manage deployments</li>
                            <li>Edit the deployment and create a new version</li>
                            <li>Ensure "Who has access" is set to <strong>"Anyone"</strong></li>
                            <li>Copy the new Web App URL</li>
                            <li>Update the URL in <code>js/main.js</code> (lines 396 and 541)</li>
                        </ol>
                    `
                });
                return false;
            }
        }

        // Step 2: Test Data Submission
        async function testDataSubmission() {
            $('#step2').removeClass('completed failed');
            $('#step2 i').attr('class', 'fas fa-circle-notch fa-spin');
            
            const testData = {
                fullName: 'Test User - ' + new Date().toLocaleTimeString(),
                mobile: '9999999999',
                email: 'test@quickfix.com',
                businessName: 'Quick Fix Test',
                businessType: 'Diagnostic Test',
                fundingRequired: 'Test Amount',
                serviceInterested: 'Quick Fix Tool Test',
                message: 'This is an automated test from the Quick Fix Tool',
                timestamp: new Date().toISOString(),
                source: 'Quick Fix Tool',
                preferredDate: '',
                preferredTime: '',
                consultWith: 'Test',
                transactionId: 'N/A',
                upiId: 'N/A',
                paymentDate: 'N/A',
                paymentTime: 'N/A'
            };
            
            try {
                const params = new URLSearchParams();
                Object.keys(testData).forEach(key => {
                    params.append(key, testData[key]);
                });
                
                const finalUrl = GOOGLE_SHEETS_URL + '?' + params.toString();
                
                await fetch(finalUrl, {
                    method: 'GET',
                    mode: 'no-cors'
                });
                
                $('#step2').addClass('completed');
                $('#step2 i').attr('class', 'fas fa-check-circle text-success');
                $('#step2Result').html(`
                    <div class="alert alert-success mt-3 mb-0">
                        <strong>✅ Test Data Sent</strong><br>
                        Check your Google Sheet for a new entry with name: <strong>${testData.fullName}</strong><br>
                        <small class="text-muted">If you don't see it, there may be an issue with the Apps Script.</small>
                    </div>
                `);
                return true;
            } catch (error) {
                $('#step2').addClass('failed');
                $('#step2 i').attr('class', 'fas fa-times-circle text-danger');
                $('#step2Result').html(`
                    <div class="alert alert-danger mt-3 mb-0">
                        <strong>❌ Submission Failed</strong><br>
                        Error: ${error.message}
                    </div>
                `);
                issuesFound.push({
                    title: 'Data Submission Failed',
                    solution: `
                        <h5>Solution:</h5>
                        <ol>
                            <li>Verify the Google Apps Script code is deployed correctly</li>
                            <li>Check Apps Script execution logs (View → Logs)</li>
                            <li>Ensure the doGet() function exists and handles all parameters</li>
                            <li>Run setupSheet() function if you haven't already</li>
                        </ol>
                    `
                });
                return false;
            }
        }

        // Step 3: Verify Form Handlers
        function verifyFormHandlers() {
            $('#step3').removeClass('completed failed');
            $('#step3 i').attr('class', 'fas fa-circle-notch fa-spin');
            
            setTimeout(() => {
                let consultationFormExists = $('#consultationForm').length > 0;
                let contactFormExists = $('#contactForm').length > 0;
                
                if (!consultationFormExists && !contactFormExists) {
                    // We're on the test page, check if forms would work on actual pages
                    consultationFormExists = true; // Assume exists on main pages
                    contactFormExists = true;
                }
                
                if (consultationFormExists || contactFormExists) {
                    $('#step3').addClass('completed');
                    $('#step3 i').attr('class', 'fas fa-check-circle text-success');
                    $('#step3Result').html(`
                        <div class="alert alert-success mt-3 mb-0">
                            <strong>✅ Form Handlers Configured</strong><br>
                            Forms are properly set up in your HTML pages.
                        </div>
                    `);
                } else {
                    $('#step3').addClass('failed');
                    $('#step3 i').attr('class', 'fas fa-times-circle text-danger');
                    $('#step3Result').html(`
                        <div class="alert alert-warning mt-3 mb-0">
                            <strong>⚠️ Forms Not Found</strong><br>
                            Unable to verify forms on this page. Ensure you're testing from index.html or contact.html
                        </div>
                    `);
                }
            }, 1000);
        }

        // Step 4: Check Email Configuration
        function checkEmailConfig() {
            $('#step4').removeClass('completed failed');
            $('#step4 i').attr('class', 'fas fa-circle-notch fa-spin');
            
            setTimeout(() => {
                $('#step4').addClass('completed');
                $('#step4 i').attr('class', 'fas fa-check-circle text-success');
                $('#step4Result').html(`
                    <div class="alert alert-info mt-3 mb-0">
                        <strong>ℹ️ Email Configuration</strong><br>
                        Email notifications are configured in the Apps Script.<br>
                        <strong>To verify:</strong>
                        <ol class="mb-0 mt-2">
                            <li>Check your inbox (and spam) for test notification</li>
                            <li>Verify recipient email in Apps Script (line ~254)</li>
                            <li>Check Gmail sending quota in Apps Script logs</li>
                        </ol>
                    </div>
                `);
            }, 1500);
        }

        // Show solutions
        function showSolutions() {
            if (issuesFound.length > 0) {
                $('#solutionsCard').show();
                let solutionsHTML = '';
                issuesFound.forEach((issue, index) => {
                    solutionsHTML += `
                        <div class="alert alert-warning">
                            <h5><i class="fas fa-exclamation-triangle"></i> Issue ${index + 1}: ${issue.title}</h5>
                            ${issue.solution}
                        </div>
                    `;
                });
                $('#solutions').html(solutionsHTML);
            } else {
                $('#solutionsCard').show();
                $('#solutions').html(`
                    <div class="alert alert-success">
                        <h5><i class="fas fa-check-circle"></i> All Tests Passed!</h5>
                        <p>Your forms should be working correctly. If you're still experiencing issues:</p>
                        <ol>
                            <li>Check your Google Sheet for the test entry</li>
                            <li>Check your email (including spam folder)</li>
                            <li>Try submitting a real form from your website</li>
                            <li>Review the Apps Script execution logs</li>
                        </ol>
                        <p class="mb-0"><strong>Next step:</strong> Open <code>test-form-debug.html</code> for more detailed testing.</p>
                    </div>
                `);
            }
        }

        // Run full diagnostic
        $('#runDiagnostic').click(async function() {
            $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Running Diagnostic...');
            issuesFound = [];
            $('#solutionsCard').hide();
            
            await testConnection();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testDataSubmission();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            verifyFormHandlers();
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            checkEmailConfig();
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            showSolutions();
            
            $(this).prop('disabled', false).html('<i class="fas fa-check-circle"></i> Diagnostic Complete');
        });

        // Test forms button
        $('#testForms').click(function() {
            window.location.href = 'test-form-debug.html';
        });

        // Auto-run on load
        $(document).ready(function() {
            setTimeout(() => {
                $('#runDiagnostic').click();
            }, 500);
        });
    </script>
</body>
</html>
