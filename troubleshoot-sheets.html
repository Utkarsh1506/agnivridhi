<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Troubleshoot Google Sheets - Agnivridhi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"/>
    <style>
        body { padding: 20px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); min-height: 100vh; }
        .container { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-width: 900px; margin: 20px auto; }
        .issue-box { background: #fff3cd; border-left: 5px solid #ffc107; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .solution-box { background: #d1ecf1; border-left: 5px solid #17a2b8; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .success-box { background: #d4edda; border-left: 5px solid #28a745; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .error-box { background: #f8d7da; border-left: 5px solid #dc3545; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .step { background: #f8f9fa; padding: 15px; margin: 15px 0; border-radius: 8px; }
        code { background: #2d2d2d; color: #50fa7b; padding: 3px 8px; border-radius: 4px; font-size: 14px; }
        .checklist { font-size: 18px; line-height: 2; }
        .btn-test { padding: 15px 30px; font-size: 18px; margin: 10px 5px; }
        #testLog { background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 8px; max-height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; margin: 20px 0; }
        .log-entry { margin: 5px 0; }
        .log-success { color: #50fa7b; }
        .log-error { color: #ff5555; }
        .log-info { color: #8be9fd; }
        .log-warning { color: #f1fa8c; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">
            <i class="fas fa-tools"></i> Google Sheets Troubleshooter
        </h1>
        <p class="text-center lead">Let's figure out why your test didn't appear in the sheet</p>

        <!-- Common Issues Checklist -->
        <div class="issue-box">
            <h3><i class="fas fa-exclamation-triangle"></i> Most Common Issues (Check These First!)</h3>
            <div class="checklist">
                <div><input type="checkbox" id="issue1"> Did you click <strong>"Deploy"</strong> after pasting the script?</div>
                <div><input type="checkbox" id="issue2"> Did you set "Who has access" to <strong>"Anyone"</strong>?</div>
                <div><input type="checkbox" id="issue3"> Did you authorize the script when prompted?</div>
                <div><input type="checkbox" id="issue4"> Did you copy the <strong>Web App URL</strong> (not the script URL)?</div>
                <div><input type="checkbox" id="issue5"> Did you add the column headers in Row 1?</div>
            </div>
        </div>

        <!-- URL Diagnostic -->
        <div class="solution-box">
            <h3><i class="fas fa-link"></i> Step 1: Verify Your Web App URL</h3>
            <p>Your Web App URL should look like this:</p>
            <code>https://script.google.com/macros/s/LONG_STRING_HERE/exec</code>
            
            <div class="mt-3">
                <label class="form-label"><strong>Paste your Web App URL here:</strong></label>
                <input type="text" class="form-control" id="webAppUrl" value="https://script.google.com/macros/s/AKfycbzoZ4xX4i4zg1_3x1VbhsU7CQ3ayZmgAnehf_cFMip2J2bxCctIqXAFYBUYvc94ogrV/exec" placeholder="https://script.google.com/macros/s/XXXXX/exec">
                
                <div class="mt-3">
                    <button class="btn btn-primary btn-test" onclick="testUrl()">
                        <i class="fas fa-vial"></i> Test URL (GET Request)
                    </button>
                    <button class="btn btn-success btn-test" onclick="testPostData()">
                        <i class="fas fa-paper-plane"></i> Test with Real Data (POST Request)
                    </button>
                </div>
            </div>
        </div>

        <!-- Test Log -->
        <div id="testLog" style="display: none;">
            <div class="log-info">üîç Test Log:</div>
            <div id="logContent"></div>
        </div>

        <!-- Results -->
        <div id="testResults"></div>

        <!-- Detailed Troubleshooting -->
        <div class="mt-5">
            <h3><i class="fas fa-bug"></i> Detailed Troubleshooting Guide</h3>

            <!-- Issue 1 -->
            <div class="step">
                <h5>‚ùå Issue: "I didn't deploy the script"</h5>
                <p><strong>Solution:</strong></p>
                <ol>
                    <li>Go to your Apps Script editor</li>
                    <li>Click <strong>Deploy</strong> ‚Üí <strong>New deployment</strong></li>
                    <li>Click ‚öôÔ∏è gear icon ‚Üí Select <strong>"Web app"</strong></li>
                    <li>Set "Who has access" to <strong>"Anyone"</strong></li>
                    <li>Click <strong>"Deploy"</strong></li>
                    <li>Copy the URL that ends with <code>/exec</code></li>
                </ol>
            </div>

            <!-- Issue 2 -->
            <div class="step">
                <h5>‚ùå Issue: "I didn't authorize the script"</h5>
                <p><strong>Solution:</strong></p>
                <ol>
                    <li>When you click Deploy, Google will show a warning</li>
                    <li>Click <strong>"Advanced"</strong></li>
                    <li>Click <strong>"Go to [Project Name] (unsafe)"</strong></li>
                    <li>Click <strong>"Allow"</strong></li>
                    <li>This gives the script permission to write to your sheet</li>
                </ol>
            </div>

            <!-- Issue 3 -->
            <div class="step">
                <h5>‚ùå Issue: "Access set to 'Only myself'"</h5>
                <p><strong>Solution:</strong></p>
                <ol>
                    <li>Go to Apps Script editor</li>
                    <li>Click <strong>Deploy</strong> ‚Üí <strong>Manage deployments</strong></li>
                    <li>Click ‚úèÔ∏è (pencil icon) to edit</li>
                    <li>Change "Who has access" to <strong>"Anyone"</strong></li>
                    <li>Click <strong>"Deploy"</strong></li>
                    <li>Get the NEW Web App URL</li>
                </ol>
            </div>

            <!-- Issue 4 -->
            <div class="step">
                <h5>‚ùå Issue: "Wrong URL copied"</h5>
                <p><strong>The WRONG URL looks like:</strong></p>
                <code>https://script.google.com/home/projects/XXXXX/edit</code>
                <p class="mt-2"><strong>The CORRECT URL looks like:</strong></p>
                <code>https://script.google.com/macros/s/XXXXX/exec</code>
                <p class="mt-2"><strong>How to get correct URL:</strong></p>
                <ol>
                    <li>In Apps Script, click <strong>Deploy</strong> ‚Üí <strong>Manage deployments</strong></li>
                    <li>Look for the URL in the "Web app" row</li>
                    <li>Click the <strong>copy icon</strong> next to the URL</li>
                </ol>
            </div>

            <!-- Issue 5 -->
            <div class="step">
                <h5>‚ùå Issue: "No column headers in sheet"</h5>
                <p><strong>Solution - Easy Way:</strong></p>
                <ol>
                    <li>In Apps Script editor, select <code>setupSheet</code> from dropdown</li>
                    <li>Click <strong>Run</strong> (‚ñ∂Ô∏è button)</li>
                    <li>Headers will be auto-created!</li>
                </ol>
                <p class="mt-2"><strong>Solution - Manual Way:</strong></p>
                <p>Add these headers in Row 1 (A to L):</p>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <tr>
                            <td><strong>A:</strong> Timestamp</td>
                            <td><strong>B:</strong> Full Name</td>
                            <td><strong>C:</strong> Mobile</td>
                            <td><strong>D:</strong> Email</td>
                        </tr>
                        <tr>
                            <td><strong>E:</strong> Business Name</td>
                            <td><strong>F:</strong> Business Type</td>
                            <td><strong>G:</strong> Funding Required</td>
                            <td><strong>H:</strong> Service Interested</td>
                        </tr>
                        <tr>
                            <td><strong>I:</strong> Message</td>
                            <td><strong>J:</strong> IP Address</td>
                            <td><strong>K:</strong> User Agent</td>
                            <td><strong>L:</strong> Reference ID</td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Issue 6 -->
            <div class="step">
                <h5>‚ùå Issue: "Script has errors"</h5>
                <p><strong>Solution:</strong></p>
                <ol>
                    <li>In Apps Script editor, check for red underlines in code</li>
                    <li>Make sure you copied <strong>ALL</strong> the code from <code>google-sheets-script.js</code></li>
                    <li>Don't leave any default code mixed with the script</li>
                    <li>Try: Delete everything and paste fresh code again</li>
                </ol>
            </div>
        </div>

        <!-- Manual Test Form -->
        <div class="solution-box mt-5">
            <h3><i class="fas fa-clipboard-check"></i> Step 2: Manual Test</h3>
            <p>If automatic test fails, try this manual verification:</p>
            
            <div class="step">
                <h5>üß™ Test in Apps Script Console:</h5>
                <ol>
                    <li>Go to your Apps Script editor</li>
                    <li>Select <code>doGet</code> function from the dropdown</li>
                    <li>Click <strong>Run</strong> (‚ñ∂Ô∏è)</li>
                    <li>Check <strong>Execution log</strong> at bottom</li>
                    <li>Should see: <code>GET request successful</code></li>
                    <li>If errors, read the error message carefully</li>
                </ol>
            </div>

            <div class="step">
                <h5>üìù Test with Sample Data:</h5>
                <ol>
                    <li>In your Google Sheet, manually add a row with sample data</li>
                    <li>If you can add manually, the sheet is fine</li>
                    <li>Problem is likely with the script deployment or authorization</li>
                </ol>
            </div>
        </div>

        <!-- Quick Fix -->
        <div class="success-box">
            <h3><i class="fas fa-magic"></i> Quick Fix - Start Fresh (5 minutes)</h3>
            <p>If nothing works, try this complete reset:</p>
            <ol>
                <li><strong>Delete old deployment:</strong>
                    <ul>
                        <li>Apps Script ‚Üí Deploy ‚Üí Manage deployments</li>
                        <li>Click üóëÔ∏è (trash icon) to delete</li>
                    </ul>
                </li>
                <li><strong>Copy code fresh:</strong>
                    <ul>
                        <li>Delete ALL code in Apps Script editor</li>
                        <li>Open <code>google-sheets-script.js</code></li>
                        <li>Copy everything (Ctrl+A, Ctrl+C)</li>
                        <li>Paste in Apps Script (Ctrl+V)</li>
                        <li>Save (Ctrl+S)</li>
                    </ul>
                </li>
                <li><strong>Deploy fresh:</strong>
                    <ul>
                        <li>Deploy ‚Üí New deployment</li>
                        <li>Type: Web app</li>
                        <li>Execute as: Me</li>
                        <li>Who has access: <strong>Anyone</strong></li>
                        <li>Deploy ‚Üí Authorize ‚Üí Allow</li>
                        <li>Copy NEW Web App URL</li>
                    </ul>
                </li>
                <li><strong>Test again</strong> using this page!</li>
            </ol>
        </div>

        <!-- Support -->
        <div class="text-center mt-5">
            <h4>Still Not Working?</h4>
            <p>Take a screenshot of:</p>
            <ul class="text-start" style="display: inline-block;">
                <li>Your Apps Script deployment settings</li>
                <li>The Execution log from Apps Script</li>
                <li>The error message from this test page</li>
            </ul>
            <p>And email to: <a href="mailto:tech@agnivridhiindia.com">tech@agnivridhiindia.com</a></p>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script>
        // Prefill the URL if config is provided
        (function(){
            try {
                if (window.AGNI_SHEETS_URL) {
                    var el = document.getElementById('webAppUrl');
                    if (el && !el.value) { el.value = window.AGNI_SHEETS_URL; }
                }
            } catch(e){}
        })();

        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const contentDiv = document.getElementById('logContent');
            logDiv.style.display = 'block';
            
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            
            let icon = '‚Ä¢';
            if (type === 'success') icon = '‚úì';
            if (type === 'error') icon = '‚úó';
            if (type === 'warning') icon = '‚ö†';
            
            entry.textContent = `[${timestamp}] ${icon} ${message}`;
            contentDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function testUrl() {
            const url = document.getElementById('webAppUrl').value;
            const resultsDiv = document.getElementById('testResults');
            
            document.getElementById('logContent').innerHTML = '';
            
            if (!url) {
                resultsDiv.innerHTML = '<div class="error-box"><strong>‚ùå Error:</strong> Please paste your Web App URL first!</div>';
                return;
            }
            
            if (!url.includes('script.google.com/macros')) {
                resultsDiv.innerHTML = '<div class="error-box"><strong>‚ùå Wrong URL Format!</strong><br>Your URL should look like:<br><code>https://script.google.com/macros/s/XXXXX/exec</code><br><br>The URL you pasted looks like a script editor URL, not a Web App URL.<br><br>Go to: <strong>Deploy ‚Üí Manage deployments</strong> and copy the Web App URL from there.</div>';
                log('Invalid URL format detected', 'error');
                return;
            }
            
            if (!url.endsWith('/exec')) {
                resultsDiv.innerHTML = '<div class="error-box"><strong>‚ö† Warning:</strong> Your URL doesn\'t end with <code>/exec</code>. This might not work.<br>Make sure you copied the Web App URL, not the script URL.</div>';
                log('URL does not end with /exec', 'warning');
            }
            
            resultsDiv.innerHTML = '<div class="solution-box"><i class="fas fa-spinner fa-spin"></i> Testing URL with GET request...</div>';
            log('Starting GET request test', 'info');
            log(`URL: ${url}`, 'info');
            
            fetch(url)
                .then(response => {
                    log(`Response status: ${response.status}`, response.ok ? 'success' : 'error');
                    return response.json();
                })
                .then(data => {
                    log('Response received', 'success');
                    log(`Data: ${JSON.stringify(data)}`, 'info');
                    
                    if (data.status === 'active') {
                        resultsDiv.innerHTML = `
                            <div class="success-box">
                                <h4><i class="fas fa-check-circle"></i> Success! Your Web App is Active!</h4>
                                <p><strong>Message:</strong> ${data.message}</p>
                                <p><strong>Version:</strong> ${data.version || 'N/A'}</p>
                                <p class="mb-0">‚úÖ Your script is deployed correctly!</p>
                                <p class="mt-3"><strong>Next:</strong> Click the green "Test with Real Data" button to send actual form data.</p>
                            </div>
                        `;
                        log('Web App is working correctly!', 'success');
                    } else {
                        resultsDiv.innerHTML = `
                            <div class="error-box">
                                <h4>‚ö† Web App Responded, But...</h4>
                                <p>Got response: ${JSON.stringify(data)}</p>
                                <p>This means your URL is correct, but the script might not be set up properly.</p>
                                <p><strong>Check:</strong> Did you copy ALL the code from google-sheets-script.js?</p>
                            </div>
                        `;
                        log('Unexpected response from Web App', 'warning');
                    }
                })
                .catch(error => {
                    log(`Error: ${error.message}`, 'error');
                    resultsDiv.innerHTML = `
                        <div class="error-box">
                            <h4><i class="fas fa-times-circle"></i> Connection Failed</h4>
                            <p><strong>Error:</strong> ${error.message}</p>
                            <h5 class="mt-3">Common Causes:</h5>
                            <ul>
                                <li>‚ùå Script not deployed as Web App</li>
                                <li>‚ùå "Who has access" set to "Only myself" instead of "Anyone"</li>
                                <li>‚ùå Script not authorized (need to click "Allow" when prompted)</li>
                                <li>‚ùå Wrong URL copied (should end with /exec)</li>
                            </ul>
                            <p class="mt-3"><strong>Fix:</strong> Follow the "Quick Fix - Start Fresh" guide below</p>
                        </div>
                    `;
                });
        }

        function testPostData() {
            const url = document.getElementById('webAppUrl').value;
            const resultsDiv = document.getElementById('testResults');
            
            if (!url) {
                resultsDiv.innerHTML = '<div class="error-box"><strong>‚ùå Error:</strong> Please paste your Web App URL and test it with GET first!</div>';
                return;
            }
            
            resultsDiv.innerHTML = '<div class="solution-box"><i class="fas fa-spinner fa-spin"></i> Sending test data to your Google Sheet...</div>';
            log('Starting POST request with test data', 'info');
            
            const testData = {
                fullName: 'Test User from Troubleshooter',
                mobile: '9876543210',
                email: 'test@agnivridhiindia.com',
                businessName: 'Test Business Ltd',
                businessType: 'Service',
                fundingRequired: '‚Çπ25-50 Lakhs',
                serviceInterested: 'CGTMSE Loan',
                message: 'This is an automated test from the troubleshooter page - ' + new Date().toLocaleString(),
                timestamp: new Date().toISOString(),
                ipAddress: '127.0.0.1',
                userAgent: navigator.userAgent
            };
            
            log('Test data prepared', 'info');
            log(`Sending to: ${url}`, 'info');
            
            fetch(url, {
                method: 'POST',
                mode: 'no-cors', // Important for cross-origin requests
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(testData)
            })
            .then(response => {
                log('POST request sent successfully', 'success');
                // Note: no-cors mode means we can't read the response
                resultsDiv.innerHTML = `
                    <div class="success-box">
                        <h4><i class="fas fa-check-circle"></i> Test Data Sent!</h4>
                        <p><strong>Check your Google Sheet now!</strong></p>
                        <p>A new row should appear with:</p>
                        <ul>
                            <li><strong>Name:</strong> Test User from Troubleshooter</li>
                            <li><strong>Mobile:</strong> 9876543210</li>
                            <li><strong>Email:</strong> test@agnivridhiindia.com</li>
                            <li><strong>Business:</strong> Test Business Ltd</li>
                            <li><strong>Message:</strong> Automated test + timestamp</li>
                        </ul>
                        <hr>
                        <h5>‚úÖ If you see the data:</h5>
                        <p>Congratulations! Your Google Sheets integration is working!</p>
                        <p><strong>Next step:</strong> Update your <code>api/consultation-handler.php</code> file with this URL.</p>
                        
                        <h5 class="mt-3">‚ùå If you DON'T see the data:</h5>
                        <ol>
                            <li>Wait 10 seconds and refresh your Google Sheet</li>
                            <li>Check if column headers exist in Row 1</li>
                            <li>Check Apps Script execution log for errors</li>
                            <li>Try the "Quick Fix - Start Fresh" guide below</li>
                        </ol>
                    </div>
                `;
                log('Check your Google Sheet for the new row!', 'success');
            })
            .catch(error => {
                log(`POST Error: ${error.message}`, 'error');
                resultsDiv.innerHTML = `
                    <div class="error-box">
                        <h4><i class="fas fa-times-circle"></i> Failed to Send Data</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p>This usually means the Web App URL is incorrect or not accessible.</p>
                        <p><strong>Solution:</strong> Follow the "Quick Fix - Start Fresh" guide below.</p>
                    </div>
                `;
            });
        }
    </script>
</body>
</html>
